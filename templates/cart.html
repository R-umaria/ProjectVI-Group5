{% extends "base.html" %}
{% block title %}Cart - BoxedWithLove{% endblock %}
{% block main_class %} cart-container{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">

<section class="cart-header full-bleed" aria-labelledby="cart-title">
  <div class="wrap">
    <h1 id="cart-title" class="cart-title">Your Cart</h1>
  </div>
</section>

<section class="page cart-page">
  <div class="cart-grid">
    <!-- Cart items -->
    <div class="cart-items-col">
      <div id="cartItems" class="cart-items" aria-live="polite">
        <!-- Filled by JS -->
      </div>

      <a href="/products" class="cart-continue" aria-label="Continue shopping">
        <span class="cart-continue-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </span>
        Continue Shopping
      </a>
    </div>

    <!-- Order summary -->
    <aside class="cart-summary" aria-labelledby="summary-title">
      <h2 id="summary-title" class="cart-summary-title">Order Summary</h2>

      <div class="cart-summary-rows">
        <div class="cart-summary-row">
          <span class="muted">Subtotal</span>
          <span id="subtotal" class="cart-money">$0.00</span>
        </div>
        <div class="cart-summary-row">
          <span class="muted">Estimated Tax</span>
          <span id="tax" class="cart-money">$0.00</span>
        </div>
        <div class="cart-summary-row">
          <span class="muted">Shipping</span>
          <span class="cart-shipping">Free</span>
        </div>
      </div>

      <div class="cart-divider" role="separator"></div>

      <div class="cart-total-row">
        <span class="cart-total-label">Total</span>
        <span id="total" class="cart-total">$0.00</span>
      </div>

      {% if session.get("user_id") %}
        <a href="/checkout" class="btn btn-primary btn-lg cart-checkout">Proceed to Checkout</a>
      {% else %}
        <button type="button" onclick="handleCheckout()" class="btn btn-primary btn-lg cart-checkout">
          Sign in to Checkout
        </button>
        <p class="cart-auth-note muted">
          You'll need to sign in or create an account to complete your purchase.
        </p>
      {% endif %}
    </aside>
  </div>
</section>

<script>
  // Load cart when page loads
  document.addEventListener('DOMContentLoaded', loadCart);

  async function loadCart() {
    try {
      const response = await fetch('/api/cart');
      const data = await response.json();

      displayCartItems(data.items);
      updateSummary(data.summary);
    } catch (error) {
      console.error('Error loading cart:', error);
    }
  }

  function displayCartItems(items) {
    const container = document.getElementById('cartItems');

    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="cart-empty">
          <div class="cart-empty-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" />
              <path d="M3 6h18" />
              <path d="M16 10a4 4 0 0 1-8 0" />
            </svg>
          </div>
          <h3 class="cart-empty-title">Your cart is empty</h3>
          <p class="muted cart-empty-sub">Looks like you haven't added any gift baskets to your cart yet.</p>
          <a href="/products" class="btn btn-primary btn-lg cart-empty-cta">
            <span aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6" />
              </svg>
            </span>
            Start Shopping
          </a>
        </div>
      `;
      return;
    }

    container.innerHTML = items.map((item) => {
      const lineTotal = (item.subtotal_cents ?? (item.price_cents * item.quantity)) / 100;
      const img = item.product_image ? `<img src="${item.product_image}" alt="${escapeHtml(item.product_name)}" loading="lazy">` : `<span class="cart-thumb-emoji" aria-hidden="true">üéÅ</span>`;
      const desc = item.product_description ? `<p class="cart-item-meta">${escapeHtml(item.product_description)}</p>` : '';

      return `
        <article class="cart-item" data-item-id="${item.id}">
          <div class="cart-item-row">
            <a class="cart-thumb" href="/products/${item.product_id}" aria-label="View ${escapeHtml(item.product_name)}">
              ${img}
            </a>

            <div class="cart-item-main">
              <div class="cart-item-top">
                <div class="cart-item-text">
                  <a class="cart-item-name" href="/products/${item.product_id}">${escapeHtml(item.product_name)}</a>
                  ${desc}
                </div>
                <div class="cart-item-price">$${lineTotal.toFixed(2)}</div>
              </div>

              <div class="cart-item-actions">
                <div class="qty" role="group" aria-label="Quantity controls">
                  <button type="button" class="qty-btn" aria-label="Decrease quantity" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">‚àí</button>
                  <span class="qty-value" aria-label="Quantity">${item.quantity}</span>
                  <button type="button" class="qty-btn" aria-label="Increase quantity" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
                </div>

                <button type="button" class="cart-remove" onclick="removeItem('${item.id}')">
                  <span class="cart-remove-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18" />
                      <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                      <path d="M10 11v6" />
                      <path d="M14 11v6" />
                    </svg>
                  </span>
                  Remove
                </button>
              </div>
            </div>
          </div>
        </article>
      `;
    }).join('');
  }

  function updateSummary(summary) {
    document.getElementById('subtotal').textContent = `$${(summary.subtotal_cents / 100).toFixed(2)}`;
    document.getElementById('tax').textContent = `$${(summary.tax_cents / 100).toFixed(2)}`;
    document.getElementById('total').textContent = `$${(summary.total_cents / 100).toFixed(2)}`;
  }

  async function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return removeItem(itemId);

    try {
      const response = await fetch(`/api/cart/items/${itemId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: newQuantity })
      });

      if (response.ok) loadCart();
    } catch (error) {
      console.error('Error updating quantity:', error);
    }
  }

  async function removeItem(itemId) {
    try {
      const response = await fetch(`/api/cart/items/${itemId}`, { method: 'DELETE' });
      if (response.ok) loadCart();
    } catch (error) {
      console.error('Error removing item:', error);
    }
  }

  function handleCheckout() {
    window.location.href = '/login?redirect=/checkout/shipping';
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }
</script>
{% endblock %}
