{% extends "base.html" %}
{% block title %}{{ product.name }} - BoxedWithLove{% endblock %}
{% block main_class %} product-container{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_detail.css') }}">

<section class="product-header full-bleed" aria-label="Breadcrumb">
  <div class="wrap">
    <a class="product-back" href="{{ url_for('web_products') }}">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M15 18l-6-6 6-6" />
      </svg>
      Back to Shop
    </a>
  </div>
</section>

<section class="page product-page" data-product-detail data-product-id="{{ product.id }}" data-unit-price-cents="{{ product.price_cents }}" data-max-qty="{{ product.stock if product.stock and product.stock > 0 else 1 }}">

  <div class="product-grid">
    <!-- Media -->
    <div class="product-media" aria-label="Product image">
      {% if is_featured %}
        <span class="badge" aria-label="Featured">Featured</span>
      {% endif %}
      {% if (not product.is_available) or (product.stock <= 0) %}
        <span class="badge badge-danger" style="top: 54px;">Out of Stock</span>
      {% endif %}

      {% if product.image_url %}
        <img src="{{ product.image_url }}" alt="{{ product.name }}" loading="lazy" />
      {% else %}
        <div class="product-emoji" aria-hidden="true">üéÅ</div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="product-info">
      {% if product.category %}
        <a class="product-category-link" href="{{ url_for('web_products', category=product.category.category_name) }}">{{ product.category.category_name }}</a>
      {% endif %}

      <h1 class="product-title">{{ product.name }}</h1>

      <div class="product-rating-line" aria-label="Average rating {{ '%.1f'|format(avg_rating) }} out of 5">
        {% set full = avg_rating|round(0, 'half_even')|int %}
        <span class="stars" aria-hidden="true">
          {% for i in range(5) %}{% if i < full %}&#9733;{% else %}&#9734;{% endif %}{% endfor %}
        </span>
        <span class="muted small">{{ '%.1f'|format(avg_rating) }} ({{ reviews|length }} review{{ '' if reviews|length == 1 else 's' }})</span>
      </div>

      <div class="product-price-lg">${{ "%.2f"|format(product.price_cents/100) }}</div>

      {% if display_description %}
        <p class="product-desc muted">{{ display_description }}</p>
      {% endif %}

      {% if inside_items and inside_items|length > 0 %}
        <div class="product-inside">
          <h3 class="product-inside-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
              <path d="M3.27 6.96L12 12.01l8.73-5.05" />
              <path d="M12 22.08V12" />
            </svg>
            What's Inside
          </h3>
          <ul class="product-inside-list">
            {% for item in inside_items %}
              <li class="product-inside-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M20 6 9 17l-5-5" />
                </svg>
                <span>{{ item }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="product-stock">
        {% if product.stock > 0 and product.is_available %}
          <span class="in">{{ 'Only ' ~ product.stock ~ ' left in stock' if product.stock < 10 else 'In Stock' }}</span>
        {% else %}
          <span class="out">Out of Stock</span>
        {% endif %}
      </div>

      <!-- Buy controls (desktop/tablet) -->
      <div class="product-buy" aria-label="Add to cart">
        <div class="qty" role="group" aria-label="Quantity controls">
          <button type="button" class="qty-btn" aria-label="Decrease quantity" onclick="BWLProductDetail.changeQty(-1)" {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}>‚àí</button>
          <span id="bwlQty" class="qty-value" aria-label="Quantity">1</span>
          <button type="button" class="qty-btn" aria-label="Increase quantity" onclick="BWLProductDetail.changeQty(1)" {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}>+</button>
        </div>

        <button
          class="btn btn-primary btn-lg"
          type="button"
          onclick="BWLProductDetail.addToCart()"
          {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}
        >
          Add to Cart
        </button>
      </div>

      <p id="add-msg" class="muted" aria-live="polite" style="margin-top: 10px;"></p>
    </div>
  </div>

  <!-- Reviews -->
  <section class="product-reviews" aria-labelledby="reviews-title">
    <div class="reviews-head">
      <div class="reviews-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z" />
        </svg>
        <h2 id="reviews-title" class="h2-serif" style="font-size: 30px;">Customer Reviews</h2>
      </div>

      {% if reviews|length > 0 %}
        {% set rounded = avg_rating|round(0, 'half_even')|int %}
        <div class="reviews-summary" aria-label="{{ '%.1f'|format(avg_rating) }} average rating">
          <span class="stars" aria-hidden="true">
            {% for i in range(5) %}{% if i < rounded %}&#9733;{% else %}&#9734;{% endif %}{% endfor %}
          </span>
          <span class="muted small">{{ '%.1f'|format(avg_rating) }} ({{ reviews|length }} review{{ '' if reviews|length == 1 else 's' }})</span>
        </div>
      {% endif %}
    </div>

    {% if session.get('user_id') and not has_user_reviewed %}
      <div class="review-form-card" aria-label="Write a review">
        <h3>Write a Review</h3>

        <form method="post" action="{{ url_for('web_post_review', product_id=product.id) }}" onsubmit="return BWLProductDetail.validateReviewForm(this)">
          <input type="hidden" name="rating" id="bwlRating" value="" required>

          <label class="field" style="margin-bottom: 10px;">
            <span class="field-label">Your Rating</span>
            <div class="star-input" role="radiogroup" aria-label="Select rating">
              {% for s in [1,2,3,4,5] %}
                <button type="button" class="star-btn" data-star="{{ s }}" aria-label="Rate {{ s }} out of 5">&#9733;</button>
              {% endfor %}
              <span id="bwlRatingLabel" class="muted small" style="margin-left: 8px;"></span>
            </div>
          </label>

          <label class="field">
            <span class="field-label">Your Review</span>
            <textarea class="textarea" name="comment" rows="4" maxlength="500" placeholder="Share your experience with this product..."></textarea>
            <div class="muted" style="font-size: 12px; margin-top: 6px;"><span id="bwlCharCount">0</span>/500 characters</div>
          </label>

          <div class="review-form-actions">
            <button class="btn btn-primary" type="submit">Submit Review</button>
          </div>
        </form>
      </div>
    {% elif not session.get('user_id') %}
      <p class="muted" style="margin: 8px 0 0;">
        <a class="product-category-link" href="{{ url_for('web_login') }}">Log in</a> to submit a review.
      </p>
    {% endif %}

    {% if reviews|length == 0 %}
      <div class="card" style="margin-top: 14px; background: rgba(243,234,220,0.20); text-align:center; padding: 26px;">
        <p class="muted" style="margin:0;">No reviews yet. Be the first to review this product!</p>
      </div>
    {% else %}
      <div class="review-cards">
        {% for r in reviews %}
          <article class="card review-card">
            <div class="review-card-head">
              <div class="review-user-wrap">
                <div class="review-avatar" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21a8 8 0 0 0-16 0"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div>
                  <div class="review-user-name">
                    {% if r.user %}
                      {{ (r.user.first_name ~ ' ' ~ r.user.last_name).strip() or r.user.email }}
                    {% else %}
                      {{ 'User #' ~ r.user_id }}
                    {% endif %}
                  </div>
                  <div class="review-date">{{ r.created_at|toronto_dt }}</div>
                </div>
              </div>

              <div class="stars" aria-label="Rating {{ r.rating }} out of 5">
                {% for i in range(5) %}{% if i < r.rating %}&#9733;{% else %}&#9734;{% endif %}{% endfor %}
              </div>
            </div>

            {% if r.comment %}
              <p class="muted" style="margin:0; line-height: 1.7;">{{ r.comment }}</p>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- Mobile sticky add-to-cart (mirrors v0) -->
  <div class="product-sticky" aria-label="Quick add to cart">
    <div class="product-sticky-inner">
      <div class="qty" role="group" aria-label="Quantity controls">
        <button type="button" class="qty-btn" aria-label="Decrease quantity" onclick="BWLProductDetail.changeQty(-1)" {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}>‚àí</button>
        <span id="bwlQtyMobile" class="qty-value" aria-label="Quantity">1</span>
        <button type="button" class="qty-btn" aria-label="Increase quantity" onclick="BWLProductDetail.changeQty(1)" {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}>+</button>
      </div>

      <button
        id="bwlStickyBtn"
        class="btn btn-primary btn-lg"
        type="button"
        onclick="BWLProductDetail.addToCart()"
        {% if (not product.is_available) or (product.stock <= 0) %}disabled{% endif %}
      >
        ${{ "%.2f"|format(product.price_cents/100) }}
      </button>
    </div>
  </div>
  <div class="product-sticky-spacer" aria-hidden="true"></div>

</section>

{% endblock %}
