{% extends "base_checkout.html" %}

{% block title %}Checkout â€“ Payment | BoxedWithLove{% endblock %}

{% block content %}
{% set active = 'payment' %}

<!-- Stepper -->
<div class="mb-8">
  <div class="flex items-center justify-center gap-4">
    {% set steps = [
      {'key':'shipping','label':'Shipping','n':1},
      {'key':'payment','label':'Payment','n':2},
      {'key':'review','label':'Review','n':3}
    ] %}
    {% for s in steps %}
      {% set is_active = active == s.key %}
      {% set is_past = (active == 'payment' and s.key == 'shipping') or (active == 'review' and (s.key == 'shipping' or s.key == 'payment')) %}
      <div class="flex items-center">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium
            {% if is_active %} bg-primary text-primary-foreground
            {% elif is_past %} bg-primary/20 text-primary
            {% else %} bg-secondary text-muted
            {% endif %}">
            {% if is_past %}
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M20 6 9 17l-5-5" />
              </svg>
            {% else %}
              {{ s.n }}
            {% endif %}
          </div>
          <span class="text-sm font-medium {% if is_active %}text-foreground{% else %}text-muted{% endif %}">
            {{ s.label }}
          </span>
        </div>
        {% if not loop.last %}
          <div class="w-16 h-px mx-4 {% if is_past %}bg-primary/30{% else %}bg-border{% endif %}"></div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="grid lg:grid-cols-3 gap-8 items-start">
  <!-- Left: Payment method selection -->
  <div class="lg:col-span-2">
    <div class="rounded-xl border border-border bg-card shadow-soft">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary" aria-hidden="true">ðŸ’³</div>
            <h1 class="text-lg font-semibold">Payment Method</h1>
          </div>
          <a href="{{ url_for('checkout_shipping') }}" class="text-sm font-medium text-foreground/70 hover:text-foreground">Edit Shipping</a>
        </div>

        <form method="post" action="{{ url_for('checkout_payment_post') }}" class="space-y-4" id="paymentForm">
          <div class="space-y-4" id="paymentList">
            {% if not methods %}
              <div class="rounded-xl border border-border bg-secondary/40 p-4 text-sm text-muted">
                No payment methods yet. Add one below.
              </div>
            {% endif %}

            {% for m in methods %}
              {% set checked = (selected_id == m.id) %}
              <label class="block rounded-xl border p-4 cursor-pointer transition
                {% if checked %} border-primary bg-primary/5 {% else %} border-border bg-card hover:bg-secondary/30 {% endif %}"
                data-pm-card="{{ m.id }}">
                <div class="flex items-center justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <input type="radio" name="payment_method_id" value="{{ m.id }}" class="mt-1" {% if checked %}checked{% endif %} />
                    <div>
                      <div class="font-medium">{{ m.brand }} ending in {{ m.last4 }}</div>
                      <div class="text-sm text-muted">Expires {{ "%02d"|format(m.exp_month) }}/{{ (m.exp_year|string)[-2:] }}</div>
                    </div>
                  </div>
                  {% if m.is_default %}
                    <span class="text-xs rounded-md bg-secondary px-2 py-1 text-foreground/70">Default</span>
                  {% endif %}
                </div>
              </label>
            {% endfor %}

            <button type="button" id="openAddPayment" class="w-full rounded-xl border border-dashed border-border p-4 text-left text-sm font-medium text-foreground/80 hover:bg-secondary/30">
              <span class="inline-flex items-center gap-2">
                <span aria-hidden="true">ï¼‹</span>
                Add new payment method
              </span>
            </button>
          </div>

          <div class="pt-2">
            <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground hover:opacity-95">
              Continue to Review
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Right: Order Summary -->
  <div class="lg:col-span-1">
    <div class="rounded-xl border border-border bg-card shadow-soft">
      <div class="p-6">
        <h2 class="text-lg font-semibold mb-4">Order Summary</h2>

        <div class="space-y-3 mb-4">
          {% for i in items %}
            <div class="flex items-start justify-between text-sm">
              <div class="text-foreground/90">{{ i.name }} x{{ i.quantity }}</div>
              <div class="text-foreground/90">${{ "%.2f"|format(i.line_total_cents/100) }}</div>
            </div>
          {% endfor %}
        </div>

        <div class="border-t border-border pt-4 space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-muted">Subtotal</span><span>${{ "%.2f"|format(summary.subtotal_cents/100) }}</span></div>
          <div class="flex justify-between"><span class="text-muted">Shipping</span><span>{% if summary.shipping_cents == 0 %}Free{% else %}${{ "%.2f"|format(summary.shipping_cents/100) }}{% endif %}</span></div>
          <div class="flex justify-between"><span class="text-muted">Tax</span><span>${{ "%.2f"|format(summary.tax_cents/100) }}</span></div>
          <div class="border-t border-border pt-3 flex justify-between font-semibold">
            <span>Total</span><span>${{ "%.2f"|format(summary.total_cents/100) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4">
  <div class="w-full max-w-xl rounded-xl border border-border bg-card shadow-soft">
    <div class="flex items-center justify-between border-b border-border px-6 py-4">
      <h3 class="text-lg font-semibold">Add Payment Method</h3>
      <button type="button" id="closeAddPayment" class="text-foreground/60 hover:text-foreground" aria-label="Close">âœ•</button>
    </div>

    <form id="addPaymentForm" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1" for="pm_brand">Card Type</label>
        <select id="pm_brand" class="w-full rounded-lg border border-border px-3 py-2">
          <option>Visa</option>
          <option>Mastercard</option>
          <option>Amex</option>
          <option>Discover</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="pm_last4">Last 4 Digits</label>
        <input id="pm_last4" inputmode="numeric" maxlength="4" class="w-full rounded-lg border border-border px-3 py-2" placeholder="1234" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="pm_expiry">Expiry Date</label>
        <input id="pm_expiry" class="w-full rounded-lg border border-border px-3 py-2" placeholder="MM/YY" />
      </div>

      <div class="pt-2 flex items-center justify-end gap-3">
        <button type="button" id="cancelAddPayment" class="inline-flex items-center justify-center rounded-lg border border-border px-4 py-2 text-sm font-semibold hover:bg-secondary/40">Cancel</button>
        <button type="submit" id="submitAddPayment" class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground hover:opacity-95">Add Card</button>
      </div>
      <p class="text-sm text-muted" id="addPaymentError" aria-live="polite"></p>
    </form>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('addPaymentModal');
    const openBtn = document.getElementById('openAddPayment');
    const closeBtn = document.getElementById('closeAddPayment');
    const cancelBtn = document.getElementById('cancelAddPayment');
    const form = document.getElementById('addPaymentForm');
    const err = document.getElementById('addPaymentError');

    function open() {
      err.textContent = '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function close() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    cancelBtn?.addEventListener('click', close);
    modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

    // Visual select state on payment cards
    document.querySelectorAll('input[name="payment_method_id"]').forEach((r) => {
      r.addEventListener('change', () => {
        document.querySelectorAll('[data-pm-card]').forEach((card) => {
          card.classList.remove('border-primary','bg-primary/5');
          card.classList.add('border-border');
        });
        const id = r.value;
        const active = document.querySelector(`[data-pm-card="${id}"]`);
        if (active) {
          active.classList.add('border-primary','bg-primary/5');
          active.classList.remove('border-border');
        }
      });
    });

    function parseExpiry(mmYY) {
      const raw = (mmYY || '').trim();
      const m = raw.match(/^\s*(\d{1,2})\s*\/\s*(\d{2,4})\s*$/);
      if (!m) return null;
      const month = parseInt(m[1], 10);
      let year = parseInt(m[2], 10);
      if (year < 100) year = 2000 + year;
      if (month < 1 || month > 12) return null;
      return {month, year};
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.textContent = '';

      const brand = document.getElementById('pm_brand').value;
      const last4 = document.getElementById('pm_last4').value.trim();
      const expiry = document.getElementById('pm_expiry').value;
      const exp = parseExpiry(expiry);

      if (!last4.match(/^\d{4}$/)) {
        err.textContent = 'Last 4 digits must be exactly 4 numbers.';
        return;
      }
      if (!exp) {
        err.textContent = 'Expiry must be in MM/YY format.';
        return;
      }

      const payload = {
        // MVP: we don't collect full cardholder details; store something stable.
        cardholder_name: {{ user.email|tojson }},
        brand,
        last4,
        exp_month: exp.month,
        exp_year: exp.year,
        billing_postal: null,
        is_default: false,
      };

      try {
        const res = await fetch('/api/payment-methods', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          err.textContent = data?.error?.message || 'Failed to add payment method.';
          return;
        }

        // Insert new method at top, select it
        const m = data.item;
        const list = document.getElementById('paymentList');

        const wrapper = document.createElement('label');
        wrapper.className = 'block rounded-xl border p-4 cursor-pointer transition border-primary bg-primary/5';
        wrapper.setAttribute('data-pm-card', m.id);

        wrapper.innerHTML = `
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-start gap-3">
              <input type="radio" name="payment_method_id" value="${m.id}" class="mt-1" checked />
              <div>
                <div class="font-medium">${m.brand} ending in ${m.last4}</div>
                <div class="text-sm text-muted">Expires ${String(m.exp_month).padStart(2,'0')}/${String(m.exp_year).slice(-2)}</div>
              </div>
            </div>
            ${m.is_default ? '<span class="text-xs rounded-md bg-secondary px-2 py-1 text-foreground/70">Default</span>' : ''}
          </div>
        `;

        // remove highlight from others
        document.querySelectorAll('[data-pm-card]').forEach((card) => {
          card.classList.remove('border-primary','bg-primary/5');
          card.classList.add('border-border');
        });

        // If there were "No payment methods" banner, keep it (harmless) but ideally remove it.
        // Add above "Add new" button (which is last child).
        const addBtn = document.getElementById('openAddPayment');
        list.insertBefore(wrapper, addBtn);

        // Re-bind change listener for new radio
        wrapper.querySelector('input').addEventListener('change', () => {
          document.querySelectorAll('[data-pm-card]').forEach((card) => {
            card.classList.remove('border-primary','bg-primary/5');
            card.classList.add('border-border');
          });
          wrapper.classList.add('border-primary','bg-primary/5');
          wrapper.classList.remove('border-border');
        });

        // Reset fields + close
        document.getElementById('pm_last4').value = '';
        document.getElementById('pm_expiry').value = '';
        close();
      } catch (e) {
        err.textContent = 'Network error while adding payment method.';
      }
    });
  })();
</script>

{% endblock %}
